<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>LLM API testbed</title>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.14.1/themes/smoothness/jquery-ui.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.14.1/jquery-ui.min.js"></script>
		<script src="model.js"></script>
		<script src="lib/papaparse.min.js"></script>
	
	</head>
	<style>
		 body { 			font-family:SegoeUI,Verdana,Geneva,sans-serif; font-size:14px; box-sizing:border-box; 
							padding:0; margin:0; position:fixed; width:100%; height:var(--maxvh); 
							margin-top:10vh;margin-left:12.5%;
							}
		.is {				border-radius:10px; padding-left: 8px; padding-right: 8px; padding-top: 1px;
							border: 1px solid #999; font-size: 16px; height: 25px;
							}
		.bs {				display: inline-block; border-radius: 10px; padding-left: 8px; padding-right: 8px; background-color:#ccc; color: #333;
							border: 1px solid #999; font-size: 14px; height: 25px; cursor: pointer; text-align:center;
							}

</style>
<body>
	<img style="position:absolute; top:-8vh;left:-10.5%; width:8%" src="img/agilelogo.png">
	<select id="model" class="is">
		<option>gpt-5-mini</option>		
		<option>gpt-5-nano</option>		
		<option>gpt-5</option>	
		<option>gpt-4</option>		
		<option>claude-sonnet-4-20250514</option>
		<option>claude-opus-4-20250514</option>
		<option>claude-3-haiku-20240307</option> 
		</select> &nbsp; 
	<select id="intent" class="is">
		<option>100</option>		
		<option>110</option>		
		<option>120</option>		
		<option>130</option>		
		<option>140</option>		
		<option>150</option>		
		<option>110</option>		
		<option>200</option>		
		<option>220</option>		
		<option>230</option>		
		<option>300</option>		
		<option>310</option>		
		<option>400</option>		
		<option>410</option>		
		<option>420</option>		
		<option>430</option>		
		<option>500</option>		
		<option>510</option>		
		<option>520</option>		
		<option>530</option>		
	</select> &nbsp; 
		<select id="endintent" class="is">
		<option>600</option>		
		<option>500</option>		
		<option>400</option>		
		<option>300</option>		
		<option>200</option>		
	</select> &nbsp; 	
	<select id="skip" class="is">
		<option>1</option>		
		<option>2</option>		
		<option>3</option>		
		<option>4</option>		
	</select> &nbsp; 	<button id="addremark" class="bs">Add</button> &nbsp; <button id="auto" class="bs">Auto</button>&nbsp; -> <div style="display:inline-block" id="intentNum"></div>
	<br><br>
	<input id="input"  style="width:calc(70% - 32px);padding:8px;padding-right:40px" type="text" placeholder="Type remark here or use microphone -> to talk">&nbsp; 
	<img id="talkBut" src="img/talkbut.png" style="cursor:pointer;width:48px;margin-left:-50px;vertical-align:-6px" title="Click and hold to talk">
	<button id="send" class="bs">Send</button>&nbsp; 
	Why?<input id="why" type="checkbox">
	<br><br>
	<div id="output" style="width:70%;padding:8px;border:1px solid;overflow-y:scroll;max-height:60vh"> Response will show up here...</div>
	<br><div id="promptSpan"></div>
	<br><div id="results"></div>


<script>

/////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

	var app={ said:"" };
	var d={};
	var timeStart,inAuto=false;
	var curRemark=0,curIntent=0,curQuestion="";
	var responses=[];
	var skipper=1;
	var numRemarks=0;
	var remarks=[];

	fetch('testremarks.csv?rnd='+Math.floor(Math.random()*100000))								
		.then(res =>  res.text())																
		.then(res =>{ 																																					
			remarks=Papa.parse(res, { header:true, skipEmptyLines:true }).data;					
			}
		);

  	$("#send").on("click",()=>	{ 
		let now=new Date();
		timeStart=now.getTime()
		prompt.model=$("#model").val();
		sendJsonData($("#input").val()) ;
		});

	$("#intent").on("change",()=>{
		let i=0;
		let t=$("#intent").val()-0;
		for (i=0;i<remarks.length;++i)
			if (remarks[i].intent-0 >= t) 
				break;
		curRemark=i;			
		});

	$("#addremark").on("click",()=>	{ 
		$("#input").val(remarks[curRemark].remark);
		curIntent=remarks[curRemark].intent;
		curQuestion=remarks[curRemark].remark;
		let s=curIntent;
		if (inAuto)	s+=" -- "+(responses.length)+"/"+Math.floor(numRemarks/skipper);
		$("#intentNum").text(s)
		if (curRemark < remarks.length-1)	curRemark+=skipper;
		curRemark=Math.min(curRemark,remarks.length-1);
	});

	$("#auto").on("click",(e)=>	{ 
		inAuto=!inAuto;
		numRemarks=CountRemarks($("#intent").val()-0,$("#endintent").val()-0);
		skipper=$("#skip").val()-0;
		if (!inAuto) {
			let time=0;
			let i,j,o;
			let ns=[0,0,0,0,0,0];
			let rs=[0,0,0,0,0,0];
			let tn=0,tr=0
			for (i=0;i<responses.length;++i) {
				o=responses[i];
				j=Math.floor(o.target/100)-1;
				if ((j < 0) || (j > 4)) break;
				ns[j]++;
				if (Math.floor(o.intent/100) == Math.floor(o.target/100)) rs[j]++;
				time+=o.time;
				}
				
			let s="<b>Results:</b><br>";
			for (i=0;i<5;++i) {
				tn+=ns[i];
				tr+=rs[i];
				s+=(i+1)*100+" = "+(Math.round(rs[i]/ns[i]*100))+"% -- "+rs[i]+"/"+ns[i]+"<br>";
				}
			s+="ALL = "+(Math.round(tr/tn*100))+"% -- "+tr+"/"+tn+"<br>";
			s+="Time is "+time/tn+"<br>";
			for (i=0;i<responses.length;++i) {
					o=responses[i];
				if (Math.floor(o.intent/100) != Math.floor(o.target/100))
					if (o.remark.match(/REMARK: (.*)/i))
						s+="<br>"+o.target+" -> "+o.remark.match(/REMARK: (.*)/i)[1]+" -> "+o.intent;
				}
			$("#results").html(s);

	//	let str=Papa.unparse(responses,{ header:true, skipEmptyLines:true, columns:["target","intent","remark"]  });			
	//	SaveTextAsFile("testresults.csv", str);
			}
		else{
			responses=[];
			$("#intent").trigger("change");
			$("#addremark").trigger("click");
			$("#send").trigger("click");
			}													
	});




	$("#input")[0].addEventListener('keydown', function(e) { if (e.key === 'Enter') $("#send").trigger("click") });

	$("#talkBut").on("mousedown", () => {													// ON TALK BUTTON
		$("#talkBut").prop("src","img/intalkbut.png");											// Green button
		app.said="";																			// Clear spoken cache
		app.voice.Listen()																		// Turn on speech recognition
		app.inRemark=true;																		// Teacher is talking
		});
	$("#talkBut").on("mouseup", (e) => {														// ON TALK BUTTON UP
		app.voice.StopListening();																// STT off						
		$("#talkBut").prop("src","img/talkbut.png");											// Green button
		$("#promptSpan").fadeIn(200).delay(4000).fadeOut(1000,()=>{ $("#promptSpan").html("") }).fadeIn(200);		// Animate in and out
		app.inRemark=false;																	// Teacher is not talking
		});





	function sendJsonData(remark)
	{
		let i,j,k;
		responses.push({time:0, target:curIntent, intent:0, remark:curQuestion });		
		LoadingIcon(true);
		remark=remark.replace(/\?/g,"");
		d.role=prompt.role;			d.tokens=prompt.tokens; 		d.instructions=prompt.instructions; 
		d.model=prompt.model; 		d.system=prompt.system;			d.temperature=prompt.temperature;
		d.remark=`REMARK: ${remark}\n`;
		d.content=`OBJECTIVE: ${prompt.objective}>\nINSTRUCTIONS: ${prompt.instructions}\n`;
		d.content+=prompt.options;
		if ($('#why').prop('checked')) 
			d.content+=`\nOUTPUT FORMAT: Output the numeric intent ID (e.g., 100) or "0" in bold face font. Then thoroughly explain why that option was chosen. Give the probabilies for for each option being the correct one list of percentages.`;
		else	
			d.content+=`\nOUTPUT FORMAT: Output only the numeric intent ID (e.g., 100) or "0". Do NOT output punctuation, extra words, or explanations.`;		

		let LLMserver=window.location.host.match(/localhost/i) ? "http://localhost" : "//stagetools.com";

		fetch(LLMserver+":3000/llmapi", {
			method: "POST",
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(d)
			})
		.then(res => res.json())
		.then(data => {
			let now=new Date();
			let time=(now.getTime()-timeStart)/1000-0;
			let s=time+" seconds<br><br>";
			responses[responses.length-1].time=time;
			responses[responses.length-1].intent=data.R;
			responses[responses.length-1].remark=d.remark;
			s=s.replace(/\n/g,"<br>");
			s+="Intent is: "+data.R.replace(/\n/g,"<br>")+"<br>";
			$("#output").html(s+`<button id="prompt" class="bs" style="float:right">Show prompt</button>`);
			trace(responses[responses.length-1]);
			$("#prompt").on("click",()=>{
				s=d.content.replace(/</g," [");
				s=s.replace(/>/g,"] ");
				s=s.replace(/\n/g,"<br>");
				$("#output").html($("#output").html()+"<br><b>Prompt:</b><br><br>"+s);
				$("#prompt").remove();
				});
			LoadingIcon();
			if (inAuto)	{
				if (responses.length > (remarks.length-1)/skipper) 	$("#auto").trigger("click");
				else if (curIntent > $("#endintent").val()-0) 		$("#auto").trigger("click");
				setTimeout(()=>{
					$("#addremark").trigger("click");
					$("#send").trigger("click");
					},1500);
			}
		});

	}
function CountRemarks(start=0, end=600)
{

	let i,s=0,e=remarks.length,num=0;
	for (i=0;i<remarks.length;++i)
		if (remarks[i].intent-0 >= start) break;
	s=i;
	for (i=i;i<remarks.length;++i)
		if (remarks[i].intent-0 >= end)	 break;
	e=i;
	for (i=s;i<e;++i) {
		if (remarks[i].intent-0 >= end) return(num)
		else ++num;
		}
	return num;
}

/////////////////////////////////////////////////////////////////////////////////////////////////
// VOICE (SST / TTS(
/////////////////////////////////////////////////////////////////////////////////////////////////

class Voice {																				 

	constructor()																					// CONSTRUCTOR
	{
		let i,_this=this;
		this.listening=false;																			// Recognizing flag
		this.getLastClause=false;																		// Get last clause																
		this.hasRecognition=false;																		// Assume no STT
		this.thoughtBubbles=false;																		// Flag to show thought bubbles instead of TTS
		app.voice=this;
		try {																							// Try
			this.tts=new SpeechSynthesisUtterance();													// Init TTS
			this.mac=0;																					// Assume non-mac
			if (window.navigator.userAgentData)															// Exists?
				this.mac=window.navigator.userAgentData.platform != "Windows";							// A mac?
			this.femaleVoice=this.mac ? 0 : 1;															// Female voice
			this.maleVoice=this.mac ? 1 : 0;															// Male voice
 			this.talking=0;																				// Talking flag to move mouth
			this.voices=[];																				// New array
			speechSynthesis.onvoiceschanged=()=> {														// React to voice init
				this.voices=[];																			// Clear list
				speechSynthesis.getVoices().forEach(function(voice) {									// For each voice
					if (voice.lang == "en-US")						_this.voices.push(voice);			// Just look at English
					if (voice.name == "Google UK English Female")	_this.voices.push(voice),_this.instructorVoice=_this.voices.length-1;		// Instructor's voice for all
					if (voice.name.match(/Microsoft Mark/i))		_this.voices.push(voice),_this.maleVoice=_this.voices.length-1;				// Male voice for PC
					if (voice.name == "Google US English")			_this.voices.push(voice),_this.femaleVoice=_this.voices.length-1;			// Female voice for all
					if (voice.name.match(/Alex/i))					_this.voices.push(voice),_this.maleVoice=_this.voices.length-1;				// Male voice ofr
					if (voice.name.match(/Aaron/i))					_this.voices.push(voice),_this.maleVoice=_this.voices.length-1;				// Mac male voice
					});
				};
			this.tts.onend=()=> { 																		// ON TALKING END
				this.talking=0;  																		// Stop talking animation
				};	
		} catch(e) { trace("TTS error",e) };															// On error
		
		try {																							// Try
			var SpeechRecognition=SpeechRecognition || webkitSpeechRecognition;							// Browser compatibility
			this.recognition=new SpeechRecognition();													// Init STT
			this.recognition.continuous=true;															// Continual recognition off
			this.recognition.interimResults=true;														// Return interim results?
			this.recognition.lang="en-US";																// US English
			this.recognition.onstart=()=>{ this.started=true; };										// ON STT START SET STATUS FLAG
			this.recognition.onend=()=>  { this.started=false; if (this.listening) this.Listen() };		// ON STT END RE-LISTEN	IF IN SIM											
			this.hasRecognition=true;																	// Has speechRecognition capabilities														
			
			this.recognition.onresult=(e)=>{ 															// ON RECOGNITION
				for (i=e.resultIndex; i<e.results.length;++i) 											// For each result
					if (e.results[i].isFinal) {															// If final
						app.said+=e.results[i][0].transcript;											// Add to cache
						$("#promptSpan").html(app.said ? "<span style='color:#006600'>"+app.said+"</span>" : ""); // Show portion to teacher as green
						if (this.getLastClause) {														// Get final utterance
							$("#input").val(app.said);													// Add to tine
							$("#send").trigger("click");												// Send
							app.said=""; 																// Clear cache
							this.listening=false;														// Not listening anymore
							this.getLastClause=false;													// No last phrase anymore
							this.recognition.stop(); 													// Stop recognition
							}
						}
				else $("#promptSpan").html(e.results[0][0].transcript ? app.said+e.results[0][0].transcript+" " : e.results[0][0].transcript+" "); // Show portion to teacher
				}					
			} catch(e) { trace("Voice error",e) };														// On error
		}

	Listen()																						// TURN ON SPEECH RECOGNITION
	{
		try { 
			this.getLastClause=false;																	// Get last phrase when transcribed
			if (!this.started)	this.recognition.start(); 												// Start recognition, unless already started
			this.listening=true;																		// We're listening
		} catch(e) { trace("Voice error",e) };															// On error
	}

	StopListening()																					// TURN OFF SPEECH RECOGNITION
	{
		this.getLastClause=true;																		// Get last phrase when transcribed
	}

	Talk(text, who="teacher")																			// SAY SOMETHING
	{
		if (!text)	return;																				// Nothing to say
		text=text.replace(/\{.*?\}/g,"");																// Remove any braced text
		try{																							// Try
			speechSynthesis.cancel();																	// Clear current speech queue			
			if (who == "Teacher") 		this.tts.voice=this.voices[this.instructorVoice];				// Instructor's  voice
			else if (who == "male")		this.tts.voice=this.voices[this.maleVoice];						// Set male voice
			else if (who == "female") 	this.tts.voice=this.voices[this.femaleVoice];					// Set female voice
			this.tts.rate=1.1;																			// Set voice speed rate 
			this.tts.text=text;																			// Set text
			speechSynthesis.speak(this.tts);															// Speak
		}
		catch(e) { trace("Speech error",e) };															// Catch
	}


}  // VOICE CLOSURE

	app.voice= new Voice();




////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS 
/////////////////////////////////////////////////////////////////////////////////////////////////

	function trace(msg, p1, p2, p3, p4)																// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function Sound(sound, mute)																		// PLAY SOUND
	{
		var snd=new Audio();																			// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)											// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");								// Use built in mp3
		if (!mute)	{																					// If not initing or muting	
			snd.volume=100/100;																			// Set volume
			snd.play();																					// Play it
			}
	}

function LoadingIcon(mode, size=64)																	// SHOW/HIDE LOADING ICON		
{
	if (!mode) {																						// If hiding
		$("#sf-loadingIcon").remove();																	// Remove it
		return;																							// Quit
		}
	var str=`<img src='img/loading.gif' width='${size}pc' id='sf-loadingIcon' style='position:absolute;top:-9vh;left:calc(37.5% - 32px);z-index:5000'>`;	
	$("body").append(str);																				// Add icon to container
}

function SaveTextAsFile(file, contents)															// SAVE TEXT TO LOCAL FILE
	{
		if (file.charAt(0) == "*") {																	// If asking
				GetTextBox("Type file name","", "", (s)=>{ SaveTextAsFile(s+file.substr(1), contents); });		// Ask for name
			return;																						// Quit
			}
		var textFileAsBlob=new Blob([contents], {type:'text/plain'});
		var downloadLink=document.createElement("a");
		downloadLink.download=file;
		downloadLink.innerHTML="Download File";
		downloadLink.href=window.URL.createObjectURL(textFileAsBlob);
	    downloadLink.onclick=()=>{ downloadLink.remove(); };
		downloadLink.style.display="none";
		downloadLink.id="tdll";
		document.body.appendChild(downloadLink);
		downloadLink.click();
	}

function GetTextBox(title, content, def, callback)												// GET TEXT LINE BOX
	{
		$("#confirmBoxDiv").remove();																	// Remove 
		$("body").append("<div class='lz-confirm' id='confirmBoxDiv'></div>");							// Add box								
		var str="<img src='img/smlogo.png' width='64' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span style='font-size:14px; color:#666'><b>"+title+"</b></span><br><br>";
		str+="<p>"+content+"<p>";
		str+="<p><input class='lz-is' style='width:75%' type='text' id='gtBoxTt' value='"+def+"'></p>";
		str+="<div id='dialogOK' class='lz-bs'>OK</div>";
		str+="<div id='dialogCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);																	// Add to div
		$("#gtBoxTt").focus();																			// Focus on button
		$("#gtBoxTt").on("change", function() {	callback($("#gtBoxTt").val()); $("#confirmBoxDiv").remove(); });	// ONE ENTER
		$("#dialogOK").on("click", function() {	callback($("#gtBoxTt").val()); $("#confirmBoxDiv").remove(); });	// ON OK 
		$("#dialogCancel").on("click", function() {	$("#confirmBoxDiv").remove(); });								// ON CANCEL
		}


</script>



</body>
</html>
