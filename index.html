<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>LLM API testbed</title>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.14.1/themes/smoothness/jquery-ui.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.14.1/jquery-ui.min.js"></script>
		<script src="model.js"></script>
		<script src="remarks.js"></script>
		<script src="lib/papaparse.min.js"></script>
	
	</head>
	<style>
		 body { 			font-family:SegoeUI,Verdana,Geneva,sans-serif; font-size:14px; box-sizing:border-box; 
							padding:0; margin:0; position:fixed; width:100%; height:var(--maxvh); 
							margin-top:10vh;margin-left:12.5%;
							}
		.is {				border-radius:10px; padding-left: 8px; padding-right: 8px; padding-top: 1px;
							border: 1px solid #999; font-size: 16px; height: 25px;
							}
		.bs {				display: inline-block; border-radius: 10px; padding-left: 8px; padding-right: 8px; background-color:#ccc; color: #333;
							border: 1px solid #999; font-size: 14px; height: 25px; cursor: pointer; text-align:center;
							}

</style>
<body>
	<img style="position:absolute; top:-8vh;left:-10.5%; width:8%" src="img/agilelogo.png">
	<select id="model" class="is">
		<option>gpt-5-nano</option>		
		<option>gpt-5</option>		
		<option>gpt-5-mini</option>		
		<option>claude-sonnet-4-20250514</option>
		<option>claude-opus-4-20250514</option>
		<option>claude-3-haiku-20240307</option> 
	</select> &nbsp; 
	<select id="intent" class="is">
		<option>110</option>		
		<option>110</option>		
		<option>120</option>		
		<option>130</option>		
		<option>140</option>		
		<option>150</option>		
		<option>210</option>		
		<option>220</option>		
		<option>230</option>		
		<option>310</option>		
		<option>410</option>		
		<option>420</option>		
		<option>430</option>		
		<option>510</option>		
		<option>520</option>		
		<option>530</option>		
	</select> &nbsp; 
		<select id="endintent" class="is">
		<option>600</option>		
		<option>500</option>		
		<option>400</option>		
		<option>300</option>		
		<option>200</option>		
	</select> &nbsp; <button id="addremark" class="bs">Add</button> &nbsp; <button id="auto" class="bs">Auto</button>&nbsp; -> <div style="display:inline-block" id="intentNum"></div>
	<br><br>
	<input id="input"  style="width:70%;padding:8px;" type="text">&nbsp; 
	<button id="send" class="bs">Send</button>
	<br><br>
	<div id="output" style="width:70%;padding:8px;border:1px solid;overflow-y:scroll;max-height:60vh"> Response will show up here...</div>

<script>

/////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

	var d={};
	var timeStart,inAuto=false;
	var curRemark=0,curIntent=0,curQuestion="";
	var responses=[];
	var skipper=1;

  	$("#send").on("click",()=>	{ 
		let now=new Date();
		timeStart=now.getTime()
		prompt.model=$("#model").val();
		sendJsonData($("#input").val()) ;
		});

	$("#intent").on("change",()=>{
		let i=0;
		let t=$("#intent").val()-0;
		for (i=0;i<remarks.length;++i)
			if (remarks[i].intent-0 >= t) 
				break;
		curRemark=i;			
		});

	$("#addremark").on("click",()=>	{ 
		$("#input").val(remarks[curRemark].remark);
		curIntent=remarks[curRemark].intent;
		curQuestion=remarks[curRemark].remark;
		let s=curIntent;
		if (inAuto)	s+=" -- "+(responses.length)+"/"+Math.floor(remarks.length/skipper);
		$("#intentNum").text(s)
		if (curRemark < remarks.length-1)	curRemark+=skipper;
		curRemark=Math.min(curRemark,remarks.length-1);
	});

	$("#auto").on("click",(e)=>	{ 
		inAuto=!inAuto;
		if (!inAuto) {
			let tens=0;hundreds=0,time=0,num=0;
			let i,o;
			let fields=["target","intent","time","m100s","m10s","remark"];
			for (i=0;i<responses.length;++i) {
				o=responses[i];
				o.m100s=(Math.floor(o.intent/100) == Math.floor(o.target/100)) ? 1 : 0;	
				o.m10s=(Math.floor(o.intent) == Math.floor(o.target)) ? 1 : 0;
				hundreds+=o.m100s;	
				tens+=o.m10s;	
				time+=o.time;	
				let end=$("#endintent").val()-0;
				if (o.target < end)	++num;
				}
			let str=Papa.unparse(responses,{ header:true, skipEmptyLines:true, columns:fields  });			
			SaveTextAsFile(prompt.model+".csv", str);
			
			trace("100s="+(Math.round(hundreds/num*100))+"%",hundreds,num);
			trace("10s="+(Math.round(tens/num*100))+"%",tens,num); 
			trace("time="+Math.round(time/num));
			}
		else{
			responses=[];
			$("#addremark").trigger("click");
			$("#send").trigger("click");
			}													
	});

	$("#input")[0].addEventListener('keydown', function(e) { if (e.key === 'Enter') $("#send").trigger("click") });

	function sendJsonData(remark)
	{
		let i,j;
		responses.push({time:0, target:curIntent, intent:0, remark:curQuestion });		
		LoadingIcon(true);
		d.role=prompt.role;			d.tokens=prompt.tokens; 		d.instructions=prompt.instructions; 
		d.model=prompt.model; 		d.system=prompt.system;			d.temperature=prompt.temperature;
		d.remark=`remark>Teacher said: ${remark}</remark>\n`;
		d.content=`<objective>${prompt.objective}</objective>\n<instructions>${prompt.instructions}</instructions>\n`;
		d.content+="<options>\n";
		for (i=0;i<prompt.options.length;++i) {
				d.content+="<op"+i+"><intent>"+prompt.options[i].intent+"</intent>";
				d.content+="<category>"+prompt.options[i].category+"</category>\n";
				d.content+="<description>"+prompt.options[i].description+"</description>\n";
				d.content+="<information>"+prompt.options[i].information+"</information>\n";
				d.content+="<definitions>\n";
				for (j=0;j<prompt.options[i].definitions.length;++j) 
					d.content+="- "+prompt.options[i].definitions[j]+"\n";
				d.content+="</definitions>\n</op"+i+">\n";
				if (prompt.options[i].examples) {
					d.content+="<examples>\n";
						for (j=0;j<prompt.options[i].examples.length;++j) 
						d.content+="- "+prompt.options[i].examples[j]+"\n";				
					d.content+="</examples>\n</op"+i+">\n\n";
					}
				}
			d.content+="</options>\n";
			
		
		fetch('http://localhost:3000/api', {
			method: "POST", 
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(d)
			})
		.then(res => res.json())
		.then(data => {
			let now=new Date();
			let time=(now.getTime()-timeStart)/1000-0;
			let s=time+" seconds<br><br>";
			responses[responses.length-1].time=time;
			responses[responses.length-1].intent=data.R;
			s+="<b>Intent is: "+data.R+"</b><br>";
			$("#output").html(s+`<button id="prompt" class="bs" style="float:right">Show prompt</button>`);
			$("#prompt").on("click",()=>{
				s=d.content.replace(/</g," [");
				s=s.replace(/>/g,"] ");
				s=s.replace(/\n/g,"<br>");
				$("#output").html($("#output").html()+"<br><b>Prompt:</b><br><br>"+s);
				$("#prompt").remove();
				});
			LoadingIcon();
			if (inAuto)	{
				if (responses.length > (remarks.length-1)/skipper) 	$("#auto").trigger("click");
				else if (curIntent > $("#endintent").val()) 		$("#auto").trigger("click");
				setTimeout(()=>{
					$("#addremark").trigger("click");
					$("#send").trigger("click");
					},1500);
			}
		});

	}

////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS 
/////////////////////////////////////////////////////////////////////////////////////////////////

	function trace(msg, p1, p2, p3, p4)																// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function Sound(sound, mute)																		// PLAY SOUND
	{
		var snd=new Audio();																			// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)											// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");								// Use built in mp3
		if (!mute)	{																					// If not initing or muting	
			snd.volume=100/100;																			// Set volume
			snd.play();																					// Play it
			}
	}

function LoadingIcon(mode, size=64)																	// SHOW/HIDE LOADING ICON		
{
	if (!mode) {																						// If hiding
		$("#sf-loadingIcon").remove();																	// Remove it
		return;																							// Quit
		}
	var str=`<img src='img/loading.gif' width='${size}pc' id='sf-loadingIcon' style='position:absolute;top:-9vh;left:calc(37.5% - 32px);z-index:5000'>`;	
	$("body").append(str);																				// Add icon to container
}

function SaveTextAsFile(file, contents)															// SAVE TEXT TO LOCAL FILE
	{
		if (file.charAt(0) == "*") {																	// If asking
				GetTextBox("Type file name","", "", (s)=>{ SaveTextAsFile(s+file.substr(1), contents); });		// Ask for name
			return;																						// Quit
			}
		var textFileAsBlob=new Blob([contents], {type:'text/plain'});
		var downloadLink=document.createElement("a");
		downloadLink.download=file;
		downloadLink.innerHTML="Download File";
		downloadLink.href=window.URL.createObjectURL(textFileAsBlob);
	    downloadLink.onclick=()=>{ downloadLink.remove(); };
		downloadLink.style.display="none";
		downloadLink.id="tdll";
		document.body.appendChild(downloadLink);
		downloadLink.click();
	}

function GetTextBox(title, content, def, callback)												// GET TEXT LINE BOX
	{
		
		
		$("#confirmBoxDiv").remove();																	// Remove 
		$("body").append("<div class='lz-confirm' id='confirmBoxDiv'></div>");							// Add box								
		var str="<img src='img/smlogo.png' width='64' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span style='font-size:14px; color:#666'><b>"+title+"</b></span><br><br>";
		str+="<p>"+content+"<p>";
		str+="<p><input class='lz-is' style='width:75%' type='text' id='gtBoxTt' value='"+def+"'></p>";
		str+="<div id='dialogOK' class='lz-bs'>OK</div>";
		str+="<div id='dialogCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);																	// Add to div
		$("#gtBoxTt").focus();																			// Focus on button
		$("#gtBoxTt").on("change", function() {	callback($("#gtBoxTt").val()); $("#confirmBoxDiv").remove(); });	// ONE ENTER
		$("#dialogOK").on("click", function() {	callback($("#gtBoxTt").val()); $("#confirmBoxDiv").remove(); });	// ON OK 
		$("#dialogCancel").on("click", function() {	$("#confirmBoxDiv").remove(); });								// ON CANCEL
		}



</script>



</body>
</html>
